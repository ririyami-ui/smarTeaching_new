rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isDocOwner() {
      return isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }

    function isWritingOwner() {
      return isAuthenticated() && (request.resource == null || request.resource.data.userId == request.auth.uid);
    }

    // --- Specific Collections ---

    // Users can only read and write their own document
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /chats/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /teachingPrograms/{docId} {
      // Support both docId based match and userId field based query
      allow read: if isAuthenticated() && (docId.matches(request.auth.uid + '_.*') || resource.data.userId == request.auth.uid);
      allow write: if isAuthenticated() && (docId.matches(request.auth.uid + '_.*') || request.resource.data.userId == request.auth.uid);
    }

    match /classes/{docId} {
      allow read, write: if isDocOwner() && isWritingOwner();
    }

    match /teachingJournals/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /teachingSchedules/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /students/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /legendStudents/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /lessonPlans/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /grades/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /attendance/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /infractions/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /holidays/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /subjects/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    // Supporting both old and new collection names if any
    match /absensi/{docId} {
      allow read: if isDocOwner();
      allow write: if isWritingOwner();
    }

    match /studentNotes/{docId} {
      allow read, write: if isDocOwner() && isWritingOwner();
    }

    match /kktpAssessments/{docId} {
      allow read, write: if isDocOwner() && isWritingOwner();
    }

    // --- Catch-all Catch for other collections secured by userId ---
    match /{collection}/{docId} {
      allow read: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}